name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装 yamllint
        run: |
          pip install yamllint
      
      - name: 配置 yamllint
        run: |
          cat > .yamllint << 'EOF'
          extends: default
          rules:
            line-length:
              max: 200
              level: warning
            indentation:
              spaces: 2
          EOF
      
      - name: 检查 YAML 格式
        run: |
          yamllint -d .yamllint openapi.yaml || true
      
      - name: 验证 OpenAPI 规范
        run: |
          pip install openapi-spec-validator
          openapi-spec-validator openapi.yaml

  validate:
    name: 验证 OpenAPI 规范
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: 安装验证工具
        run: |
          npm install -g @apidevtools/swagger-cli
          npm install -g swagger-parser
      
      - name: 验证 OpenAPI 3.0 规范
        run: |
          swagger-cli validate openapi.yaml
          echo "✅ OpenAPI 规范验证通过"
      
      - name: 检查规范完整性
        run: |
          swagger-cli bundle openapi.yaml -o /tmp/bundled.yaml
          echo "✅ 规范完整性检查通过"
      
      - name: 验证所有引用
        run: |
          swagger-parser validate openapi.yaml
          echo "✅ 所有引用验证通过"

